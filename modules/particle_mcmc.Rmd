---
title: "Particle MCMC"
subtitle: "BYU Summer Institute on Applied Statistics workshop"
author: "NIMBLE Development Team"
output:
  html_document:
    code_folding: show
---

# Particle MCMC

Note that at each step, one can get a Monte Carlo estimate of $p(y_t|y_{1:t-1}, theta)$, so one can multiply to estimate $p(y_{1:T}|\theta)$.

Recall that for MCMC,
 - high-dimensional latent process values in non-conjugate models often result in bad mixing
 - ideally, we'd like to integrate over $x_{1:T}$ and do MCMC only on hyperparameters
 - SMC algorithms allow us to estimate the marginal likelihood so could be embedded within MCMC for the hyperparameters

# Particle MCMC in NIMBLE

NIMBLE provides scalar and block random-walk Metropolis Hastings based on this approach: "Particle Marginal Metropolis Hastings".

Simply specify 'RW_PF' or 'RW_PF_block' in `addSampler', indicating the $x_{1:T}$ nodes as part of the control argument.

We'll look directly at the PMCMC code in [`PMCMC_samplers.R`](modules/PMCMC_samplers.R), which is simply the PMCMC samplers extracted from `MCMC_samplers.R` in the nimble R package.

The setup code creates a filtering algorithm, and then the run code runs it under the proposed hyperparameter values and uses the likelihood approximation in the Metropolis-Hastings acceptance calculation.


# Stochastic volatility example revisited

```{r, sv-code}
```

```{r, sv-model}
```

# Stochastic volatility, particle MCMC

```{r, sv-pmcmc}
stochVolConf <- configureMCMC(stochVolModel, nodes = NULL,
    monitors = c( ' beta ' , ' phi ' , ' sigma ' , ' x ' ))
stochVolConf$addSampler(target = c('beta', 'phiStar', 'sigma' , 'x0'),
                               type = 'RW_PF_block', control = list(propCov = .1 * diag(4),
                               pfType = 'auxiliary', adaptive = TRUE, pfNparticles = 200,
                               latents = 'x', pfResample = TRUE))
                               
stochVolMCMC <- buildMCMC(stochVolConf, monitors = c('beta', 'sigma', 'phi'))
cMCMC <- compileNimble(stochVolMCMC, project = stochVolModel, resetFunctions = TRUE)
samples <- runMCMC(cMCMC, niter = 10000)
```

```{r, sv-pmcmc-results}
par(mfrow = c(1, 3))
hist(samples[ , 'beta'])
hist(samples[ , 'phi'])
hist(samples[ , 'sigma'])
```
