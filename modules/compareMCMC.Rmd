---
title: "Automated MCMC comparison"
subtitle: "BYU Summer Institute on Applied Statistics workshop"
author: "NIMBLE Development Team"
output:
  html_document:
    code_folding: show
    toc: yes
    mathjax: default
---

```{r setup, include=FALSE} 
library(methods) ## needed only when building documents outside of R
library(nimble)
library(mcmcplots)
```

# Automating MCMC comparisons in NIMBLE

- NIMBLE provides tools to automatically compare MCMC efficiency
across methods.
- Methods can include different NIMBLE MCMC configurations as well as
  JAGS, OpenBUGS/WinBUGS (not tested much) and Stan (separate code
  required).
- We will use `compareMCMCs`, which calls `MCMCsuite` internally.
- `MCMCsuite` can be used directy as well.

# Example: Metropolis-Hastings vs slice sampling. NIMBLE vs. JAGS

- `compareMCMCs` and `MCMCsuite` need to build and compile the model themselves.
- (This may become more flexible in the future.)
- These functions provide a variety of pre-defined MCMC configurations and a system
for providing your own.
- I will illustrate using slice samplers instead of the default
Metropolis-Hastings samplers for `a` and `b`.

```{r, comparisons}
littersInfo <- list(code = littersCode,
                   constants = littersConstants,
                   data = littersData, inits = littersInits)

## A function to replace default samplers with slice
## samplers for requested nodes
configureSlice <- function(Rmodel, nodes) {
    MCMCconf <- configureMCMC(Rmodel) ## get a default configuration
    ## print default samplers for illustration
    MCMCconf$printSamplers(nodes)
    for(node in nodes) {
        MCMCconf$removeSamplers(node)
        MCMCconf$addSampler(target = node, type = "slice")
    }
    ## print modified samplers for illustration
    MCMCconf$printSamplers(nodes)
    MCMCconf
}

## This is only needed during Rmarkdown evaluation to avoid Rmarkdown/NIMBLE non-standard evaluation conflicts
.GlobalEnv$configureSlice <- configureSlice

## A configuration list for compareMCMCs
MCMCdefs <- list(
    nimble_slice = quote({
        ## This code will be evaluated in an environment
        ## where 'Rmodel' is the model.
        nodes <- c('a[1]','a[2]','b[1]','b[2]')
        MCMCconf <- configureMCMC(Rmodel) ## get a default configuration
        ## print default samplers for illustration
        MCMCconf$printSamplers(nodes)
        for(node in nodes) {
                 MCMCconf$removeSamplers(node)
                 MCMCconf$addSampler(target = node, type = "slice")
        }
        ## print modified samplers for illustration
        MCMCconf$printSamplers(nodes)
        MCMCconf
    })
)

littersResults <- MCMCsuite(
               littersCode,
               constants = littersConstants,
               data = littersData,
               inits = littersInits,
               MCMCs = c("jags", "nimble", "nimble_slice"),
               MCMCdefs = MCMCdefs,
               monitors = c("a", "b"),
               niter = 10000,
               burnin = 1000)

littersComparisons <- compareMCMCs(
    littersInfo,
    MCMCs = c("jags", "nimble", "nimble_slice"),
    MCMCdefs = MCMCdefs,
    monitors = c("a", "b"),
    niter = 10000,
    burnin = 1000,
    summary = FALSE)
```

# Viewing the comparisons

```{r, comparison-results}
make_MCMC_comparison_pages(littersComparisons,
                           dir = "litters_comparison_results",
                           modelNames = "littersComparisons")
```

The results are [here](litters_comparison_results/litters_comparisons.html)

# Add Stan for litters?
